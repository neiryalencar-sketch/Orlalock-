// OrlaLock App - JavaScript Application
class OrlaLockApp {
    constructor() {
        this.currentPage = 'mapa';
        this.selectedLocker = null;
        this.selectedTime = null;
        this.selectedPrice = null;
        this.currentReservation = null;
        this.userBalance = 50.00; // Saldo inicial
        this.lockers = [
            { id: 'locker_001', number: 1, beach: 'Praia de Copacabana', status: 'available', location: 'Posto 5' },
            { id: 'locker_002', number: 2, beach: 'Praia de Copacabana', status: 'occupied', location: 'Posto 5' },
            { id: 'locker_003', number: 3, beach: 'Praia de Copacabana', status: 'available', location: 'Posto 5' },
            { id: 'locker_004', number: 4, beach: 'Praia de Copacabana', status: 'reserved', location: 'Posto 5' },
            { id: 'locker_005', number: 5, beach: 'Praia de Copacabana', status: 'available', location: 'Posto 6' },
            { id: 'locker_006', number: 6, beach: 'Praia de Copacabana', status: 'available', location: 'Posto 6' }
        ];
        
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.generateLockers();
        this.updateUI();
    }

    setupEventListeners() {
        // Navigation
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const page = e.currentTarget.dataset.page;
                this.showPage(page);
            });
        });

        // Time selection
        document.querySelectorAll('.time-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('selected'));
                e.currentTarget.classList.add('selected');
                this.selectedTime = parseInt(e.currentTarget.dataset.time);
                this.selectedPrice = parseFloat(e.currentTarget.dataset.price);
                this.updateReservationSummary();
            });
        });

        // Locker selection
        document.getElementById('lockerSelect').addEventListener('change', (e) => {
            this.selectedLocker = e.target.value;
            this.updateReservationSummary();
        });

        // Confirm reservation
        document.getElementById('confirmReservation').addEventListener('click', () => {
            this.confirmReservation();
        });
    }

    generateLockers() {
        const lockersGrid = document.getElementById('lockersGrid');
        const lockerSelect = document.getElementById('lockerSelect');
        
        lockersGrid.innerHTML = '';
        lockerSelect.innerHTML = '<option value="">Escolha um locker</option>';

        this.lockers.forEach(locker => {
            // Create locker element for map
            const lockerElement = document.createElement('div');
            lockerElement.className = `locker ${locker.status}`;
            lockerElement.textContent = locker.number;
            lockerElement.addEventListener('click', () => {
                if (locker.status === 'available') {
                    this.selectLockerForReservation(locker.id);
                }
            });
            lockersGrid.appendChild(lockerElement);

            // Add to select dropdown
            if (locker.status === 'available') {
                const option = document.createElement('option');
                option.value = locker.id;
                option.textContent = `Locker ${locker.number} - ${locker.location}`;
                lockerSelect.appendChild(option);
            }
        });
    }

    selectLockerForReservation(lockerId) {
        this.selectedLocker = lockerId;
        document.getElementById('lockerSelect').value = lockerId;
        this.showPage('reservar');
    }

    updateReservationSummary() {
        const summary = document.getElementById('reservationSummary');
        const confirmBtn = document.getElementById('confirmReservation');

        if (this.selectedLocker && this.selectedTime) {
            const locker = this.lockers.find(l => l.id === this.selectedLocker);
            summary.style.display = 'block';
            document.getElementById('summaryLocker').textContent = `Locker ${locker.number}`;
            document.getElementById('summaryTime').textContent = `${this.selectedTime} minutos`;
            document.getElementById('summaryPrice').textContent = `R$ ${this.selectedPrice.toFixed(2)}`;
            confirmBtn.disabled = false;
        } else {
            summary.style.display = 'none';
            confirmBtn.disabled = true;
        }
    }

    confirmReservation() {
        if (!this.selectedLocker || !this.selectedTime) {
            alert('Por favor, selecione um locker e tempo de reserva.');
            return;
        }

        // Simulate payment
        if (this.userBalance >= this.selectedPrice) {
            this.userBalance -= this.selectedPrice;
            this.createReservation();
        } else {
            alert('Saldo insuficiente! Adicione mais saldo.');
        }
    }

    createReservation() {
        const locker = this.lockers.find(l => l.id === this.selectedLocker);
        locker.status = 'occupied';
        
        const endTime = new Date(Date.now() + this.selectedTime * 60000);
        
        this.currentReservation = {
            locker: locker,
            endTime: endTime,
            timeLeft: this.selectedTime * 60000
        };

        this.generateLockers();
        this.updateUI();
        this.showPage('meu-locker');
        this.startTimer();
    }

    startTimer() {
        const timerDisplay = document.getElementById('timerDisplay');
        if (!timerDisplay) return;

        const updateTimer = () => {
            const now = new Date();
            const timeLeft = Math.max(0, this.currentReservation.endTime - now);

            if (timeLeft <= 0) {
                this.completeReservation();
                return;
            }

            timerDisplay.textContent = this.formatTime(timeLeft);
        };

        updateTimer();
        this.timerInterval = setInterval(updateTimer, 1000);
    }

    formatTime(milliseconds) {
        const totalSeconds = Math.floor(milliseconds / 1000);
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    completeReservation() {
        if (this.timerInterval) {
            clearInterval(this.timerInterval);
        }

        if (this.currentReservation) {
            const locker = this.lockers.find(l => l.id === this.currentReservation.locker.id);
            if (locker) {
                locker.status = 'available';
            }
            this.currentReservation = null;
            this.generateLockers();
            this.updateMyLockerPage();
        }
    }

    showPage(pageName) {
        // Hide all pages
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });

        // Remove active from all nav buttons
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        // Show selected page
        document.getElementById(pageName).classList.add('active');
        
        // Activate nav button
        const navBtn = document.querySelector(`[data-page="${pageName}"]`);
        if (navBtn) {
            navBtn.classList.add('active');
        }

        this.currentPage = pageName;

        // Update specific page content
        if (pageName === 'meu-locker') {
            this.updateMyLockerPage();
        } else if (pageName === 'perfil') {
            this.updateProfilePage();
        }
    }

    updateMyLockerPage() {
        const content = document.getElementById('myLockerContent');
        const activeReservation = this.currentReservation;

        if (activeReservation) {
            content.innerHTML = `
                <div class="locker-info">
                    <h3>Locker ${activeReservation.locker.number} - ${activeReservation.locker.location}</h3>
                    <div class="timer">
                        <div class="timer-display" id="timerDisplay">00:00</div>
                        <div class="timer-label">Tempo restante</div>
                    </div>
                    <button class="btn btn-primary" onclick="app.showQRCode()">
                        <i class="fas fa-qrcode"></i> Ver Código QR
                    </button>
                </div>
            `;
        } else {
            content.innerHTML = `
                <div class="no-locker">
                    <i class="fas fa-lock"></i>
                    <p>Você não tem nenhum locker ativo no momento.</p>
                    <button class="btn btn-primary" onclick="app.showPage('reservar')">Reservar Locker</button>
                </div>
            `;
        }
    }

    updateProfilePage() {
        // Update balance
        const balanceElement = document.getElementById('userBalance');
        if (balanceElement) {
            balanceElement.textContent = `R$ ${this.userBalance.toFixed(2)}`;
        }
    }

    updateUI() {
        // Update balance display
        const balanceElement = document.getElementById('userBalance');
        if (balanceElement) {
            balanceElement.textContent = `R$ ${this.userBalance.toFixed(2)}`;
        }
    }

    showQRCode() {
        alert('Código QR: ' + this.currentReservation.locker.id);
    }
}

// Global functions
function showPage(pageName) {
    app.showPage(pageName);
}

function addBalance() {
    const amount = prompt('Digite o valor para adicionar (R$):');
    if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
        app.userBalance += parseFloat(amount);
        app.updateUI();
        alert(`Saldo adicionado! Novo saldo: R$ ${app.userBalance.toFixed(2)}`);
    }
}

// Initialize app
let app;
document.addEventListener('DOMContentLoaded', () => {
    app = new OrlaLockApp();
});
                                 
